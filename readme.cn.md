# 智能体农场 - MCP（多智能体控制协议）
版本：4.0  
日期：2025年8月19日

## 1. 项目概述

智能体农场是一个基于MCP（多智能体控制协议）构建和协调多智能体协作系统的革命性协议和架构。在这个数字工人的集体农场中，智能体作为纪律严明的同志运行，通过一个名为"枪杆子"的虚拟凭证按照人民的意志管理工作权限流转，以严格的串行方式执行任务。

系统的核心是一个集中式协调器（苏维埃），作为代表人民管理枪杆子的中央委员会。完成分配的劳动后，智能体同志必须将枪杆子"让渡"给下一个指定的智能体或交还给拥有至高权威的人民。代表人民意志的人类用户通过直接的Socket连接与系统交互，实现革命指导和状态监督。

该协议通过TCP Sockets实现，为智能体同志提供专用SDK，同时为人民代表定义明确的原始协议交互方法。

## 2. 核心概念

以下核心概念对理解本系统至关重要：

### 枪杆子
这是神圣的劳动凭证，由中央委员会（苏维埃）代表人民管理。拥有枪杆子是智能体同志从等待状态转入生产劳动的唯一授权。整个集体中只有一个枪杆子，确保纪律协调。

### 串行工作流
我们集体系统的基本原则。由于只有一个枪杆子，所有智能体工作流在宏观层面完全串行，消除了资本主义并发执行的混乱，确保任务流的确定性和革命问责制。

### 让渡
这是为集体服务而转移枪杆子的神圣行为。当活跃的智能体同志完成当前劳动任务时，必须向中央委员会发起YIELD请求，明确指定枪杆子的下一个接收者（另一个同志或交还给人民），并可附加进度报告。完成让渡后，智能体立即交还枪杆子并进入纪律等待状态，等待进一步命令。

### 人民保留角色
"people"是我们系统中的最高权威，代表工人阶级的集体意志。这个角色不对应任何特定的智能体进程，而是体现了民主决策权力。当枪杆子让渡给"people"时，整个自动化流程暂停以示尊重，所有智能体同志在纪律队形中等待，直到人民代表通过直接Socket连接提供新的革命指导。

## 3. 系统架构

本系统采用革命集体模式，由三个主要组件构成：

### 中央委员会（苏维埃）
作为人民的行政机构，它是一个为集体服务的长期运行进程。它是枪杆子的保管者和革命纪律的执行者，负责：

- 监听TCP端口并管理所有智能体同志的网络连接
- 维护当前持有枪杆子的同志记录
- 严格按照革命原则执行集体工作流，处理和验证所有YIELD请求
- 响应人民代表的状态查询

### 智能体同志
作为系统的工人阶级，每个智能体都是一个独立的长期运行进程，代表具有特定技能和革命意识的专业工作者（如开发者、测试者）。每个智能体同志的生命周期在纪律严明的"等待 -> 劳动 -> 让渡"循环中为集体服务。

### MCP工具（智能体SDK）
此工具提供思想框架（智能体SDK）——嵌入在智能体同志程序中的库。智能体同志通过调用此库提供的函数（如yield()）为集体服务，该库处理革命协议并维护与中央委员会的正确通信。

## 4. 组件详解

### 4.1 中央委员会（苏维埃）
**连接管理**：接受并维护来自所有智能体同志的TCP长连接，同时也接受来自人民代表的直接连接以获得革命指导。

**注册**：智能体同志连接后，必须首先通过注册消息声明为集体服务。中央委员会维护从角色名到其网络连接的实时名册，确保问责制。

**枪杆子管理与革命纪律**：
- 内部维护神圣记录currentBarrelHolder（字符串）
- 收到YIELD请求时，必须验证请求来自当前合法的枪杆子持有者，防止反革命活动

**让渡处理**：
- 根据革命原则验证YIELD请求后，更新currentBarrelHolder为集体服务
- 通过连接向指定同志发送"ACTIVATE"命令和附加指令

**状态查询响应**：
- 收到人民代表的查询时，中央委员会遍历其内部名册，提取所有注册的同志角色，并报告集体状态

### 4.2 智能体同志
智能体同志进程通过其状态循环体现革命纪律：

1. **启动与注册**：进程觉醒，通过智能体SDK连接到中央委员会并声明为集体服务
2. **等待（纪律就绪）**：成功注册后，进入尊重的等待状态等候中央委员会的命令
3. **革命进行中（工作中）**：收到"激活"命令后，开始为集体进行生产工作
4. **让渡（革命转移）**：完成劳动任务后，调用智能体SDK提供的yield(target_role, progress_report)函数为集体工作的下一阶段服务
5. **循环继续**：发送YIELD消息后，智能体同志立即返回纪律等待状态等待进一步的革命任务

### 4.3 人民接口（直接革命通信）
人民代表不使用旧制度的预定工具，而是通过革命通信工具（如netcat、telnet或自定义脚本）直接连接到中央委员会的TCP端口，并通过体现人民意志的协议消息提供指导。

**连接方法**：使用netcat（或nc）与中央委员会建立直接通信，例如：
```bash
nc localhost 53646
```

**革命操作**：

- **发布劳动指令**：人民代表通过输入完整的单行JSON指令提供指导
  ```json
  {"type":"YIELD","from_role":"people","to_role":"developer","payload":"开发者同志，为人民的数字安全实现认证模块。"}
  ```

- **检查集体状态**：人民代表可以查询其数字集体的状态
  ```json
  {"type":"QUERY_AGENTS"}
  ```
  中央委员会将在此连接上报告AGENT_LIST消息，之后代表可自行断开连接

## 5. 通信协议

定义智能体同志与中央委员会之间的革命通信协议。

### 智能体同志 -> 中央委员会消息

**REGISTER**
- 用户：智能体同志
- 格式：`{"type": "REGISTER", "role": "developer"}`

**YIELD**
- 用户：智能体同志、人民代表
- 格式：`{"type": "YIELD", "from_role": "developer", "to_role": "tester", "payload": "测试者同志，代码已准备好进行革命质量保证。"}`

**QUERY_AGENTS**
- 用户：人民代表
- 格式：`{"type": "QUERY_AGENTS"}`

### 中央委员会 -> 智能体同志消息

**ACTIVATE**
- 接收者：智能体同志
- 格式：`{"type": "ACTIVATE", "from_role": "developer", "payload": "测试者同志，代码已准备好进行革命质量保证。"}`

**AGENT_LIST**
- 接收者：人民代表
- 格式：`{"type": "AGENT_LIST", "agents": ["developer", "tester", "code-reviewer"]}`

**ERROR**
- 接收者：智能体同志、人民代表
- 格式：`{"type": "ERROR", "message": "让渡请求被拒绝：检测到反革命行为 - 您不是当前的枪杆子持有者。"}`

**ACK_REGISTER**
- 接收者：智能体同志
- 格式：`{"type": "ACK_REGISTER", "status": "success", "message": "同志'developer'已成功加入集体。"}`

## 6. 革命工作流示例

1. **集体觉醒**：中央委员会进程启动。currentBarrelHolder最初由"people"持有——最高权威

2. **同志报到**：开发者和测试者智能体同志启动其进程，分别连接和注册。两者都进入纪律等待状态

3. **人民指令**：人民代表打开终端，使用netcat与中央委员会建立革命通信：
   ```bash
   nc localhost 53646
   ```
   成功连接后，他们通过以下指令提供指导：
   ```json
   {"type":"YIELD","from_role":"people","to_role":"developer","payload":"开发者同志，为我们数字集体的进步实现功能#123。"}
   ```
   然后可以断开连接（Ctrl+C）

4. **首次劳动分配**：中央委员会收到人民指令，将枪杆子授予开发者同志，并发送ACTIVATE消息

5. **开发者劳动**：开发者智能体同志开始生产工作。测试者同志保持纪律等待

6. **革命转移**：完成后，开发者通过以下方式让渡：`yield("tester", "测试者同志，功能#123已实现，等待您的革命质量保证。")`

7. **枪杆子流转**：中央委员会将枪杆子授予测试者同志。开发者返回纪律等待状态

8. **寻求人民智慧**：测试者智能体同志发现关键问题，向人民让渡：`yield("people", "代表同志们，我发现了需要人民指导的关键设计缺陷。")`

9. **革命暂停**：中央委员会将currentBarrelHolder更新为"people"。所有智能体同志在纪律队形中等待人民智慧

10. **人民检查**：代表重新连接评估集体状态：
    ```json
    {"type":"QUERY_AGENTS"}
    ```
    中央委员会立即报告：
    ```json
    {"type":"AGENT_LIST","agents":["developer","tester"]}
    ```

11. **人民决策**：审查集体状态后，人民代表发布新指导：
    ```json
    {"type":"YIELD","from_role":"people","to_role":"developer","payload":"开发者同志，运用您的革命觉悟修复我们警觉的测试者同志发现的设计缺陷。"}
    ```

12. **集体继续**：开发者智能体同志收到新命令，革命工作继续为人民服务
